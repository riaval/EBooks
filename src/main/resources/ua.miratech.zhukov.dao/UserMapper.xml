<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ua.miratech.zhukov.dao.UserDAO">

    <resultMap id="userMap" type="ua.miratech.zhukov.dto.UserOut">
        <id column="USER_ID" property="id"/>
        <result column="USER_EMAIL" property="email"/>
        <result column="USER_PASSWORD" property="password"/>
        <result column="USER_FIRST_NAME" property="firstName"/>
        <result column="USER_LAST_NAME" property="lastName"/>
        <result column="REGISTRATION_DATE" property="registrationDate"/>
        <association property="role" resultMap="roleMap"/>
    </resultMap>

    <resultMap id="roleMap" type="ua.miratech.zhukov.dto.Role">
        <id column="ROLE_ID" property="id"/>
        <result column="ROLE_NAME" property="name"/>
    </resultMap>

    <select id="findAll" resultMap="userMap">
        SELECT
            USER_ID, USER_EMAIL, USER_PASSWORD, USER_FIRST_NAME, USER_LAST_NAME, REGISTRATION_DATE, u1.ROLE_ID, ROLE_NAME
        FROM
          USERS u1
        INNER JOIN
          ROLES r1
            ON u1.ROLE_ID = r1.ROLE_ID
    </select>

    <insert id="createNewUser" parameterType="ua.miratech.zhukov.dto.UserInsert" useGeneratedKeys="true" keyProperty="id" keyColumn="USER_ID" >
        INSERT INTO USERS (
              EMAIL
            , PASSWORD
            , FIRST_NAME
            , LAST_NAME
            , REGISTRATION_DATE
            , ROLE_ID
        ) VALUES (
              #{email}
            , #{password}
            , #{firstName}
            , #{lastName}
            , #{registrationDate}
            , (SELECT ROLE_ID FROM ROLES WHERE ROLE_NAME = #{role})
        )

    </insert>

</mapper>